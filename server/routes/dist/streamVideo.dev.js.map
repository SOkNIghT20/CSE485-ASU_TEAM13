{"version":3,"sources":["streamVideo.js"],"names":["fs","require","express","router","Router","path","passport","get","req","res","next","file_name","query","file","console","log","ext_name","extname","file_type","stat","err","code","status","send","fileSize","size","range","headers","parts","replace","split","start","parseInt","end","chunksize","createReadStream","head","writeHead","pipe","module","exports"],"mappings":"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","sourcesContent":["\"use strict\";\r\n\r\n//import {videoSource} from \"../../src/app/services/search.component\";\r\n/*\r\nREFERENCE MATERIAL https://medium.com/@daspinola/video-stream-with-node-js-and-html5-320b3191a6b6\r\n */\r\nvar fs = require('fs');\r\nvar express = require('express');\r\nvar router = express.Router();\r\nvar path = require('path');\r\nconst passport = require('passport');\r\n\r\nrouter.get('/stream'/*, passport.authenticate('jwt', { session: false })*/, function (req, res, next) {\r\n\t//var fileName = path.basename(req.query.file);\r\n\tvar file_name = req.query.file;\r\n\tconsole.log(\"streamVideo.js file_name:\", file_name);\r\n\t\t\r\n\t//once we know where files will be located we can switch it out from the /assets folder\r\n\t//const path = file_name; //'assets/sample.mp4';\r\n\t\r\n\tvar ext_name = path.extname(file_name);\r\n\tvar file_type = '';\r\n\t\r\n\tswitch(ext_name) {\r\n    case '.mp4':\r\n        file_type = 'video/mp4';\r\n        break;\r\n    case '.vtt':\r\n        file_type = 'text/vtt';\r\n        break;\r\n    case '.wav':\r\n        file_type = 'audio/wav';\r\n        break;\r\n\t}\r\n\t//console.log(\"streamVideo.js ext:\", ext_name);\r\n\tconsole.log(\"looking\");\r\n\r\n\t// Asynchronously check if the file exists and get its stats\r\n\tfs.stat(file_name, (err, stat) => {\r\n\t\tif (err) {\r\n\t\t\tconsole.log(\"error in lebron:\", err);\r\n\t\t\t// Provide more specific error messages based on the error code\r\n\t\t\tif (err.code === 'ENOENT') {\r\n\t\t\t\t// File not found\r\n\t\t\t\treturn res.status(404).send(`Sorry: Video no longer archived - file not found at \"${file_name}\".`);\r\n\t\t\t} else if (err.code === 'EACCES') {\r\n\t\t\t\t// Permission denied\r\n\t\t\t\treturn res.status(403).send(`Sorry: Video no longer archived - permission denied to access \"${file_name}\".`);\r\n\t\t\t} else {\r\n\t\t\t\t// Other errors\r\n\t\t\t\treturn res.status(500).send(`Sorry: Video no longer archived - an unexpected error occurred while accessing \"${file_name}\".`);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconsole.log(\"found \" + file_name);\r\n\t\tconst fileSize = stat.size;\r\n\t\tconst range = req.headers.range;\r\n\t\tif (range) {\r\n\t\t\tconst parts = range.replace(/bytes=/, \"\").split(\"-\");\r\n\t\t\tconst start = parseInt(parts[0], 10);\r\n\t\t\tconst end = parts[1]\r\n\t\t\t\t? parseInt(parts[1], 10)\r\n\t\t\t\t: fileSize - 1;\r\n\t\t\tconst chunksize = (end - start) + 1;\r\n\t\t\tconsole.log('RANGE: ' + start + ' - ' + end + ' = ' + chunksize);\t//DEBUG\r\n\t\t\tconst file = fs.createReadStream(file_name, { start: start, end: end });\r\n\t\t\tconst head = {\r\n\t\t\t\t'Content-Range': 'bytes ' + start + '-' + end + '/' + fileSize,\r\n\t\t\t\t'Accept-Ranges': 'bytes',\r\n\t\t\t\t'Content-Length': chunksize,\r\n\t\t\t\t'Content-Type': file_type\r\n\t\t\t};\r\n\t\t\tres.writeHead(206, head);\r\n\t\t\tfile.pipe(res);\r\n\t\t} else {\r\n\t\t\tconst head = {\r\n\t\t\t\t'Content-Length': fileSize,\r\n\t\t\t\t'Content-Type': file_type\r\n\t\t\t};\r\n\t\t\tres.writeHead(200, head);\r\n\t\t\tfs.createReadStream(file_name).pipe(res);\r\n\t\t}\r\n\t});\r\n});\r\nmodule.exports = router;\r\n"],"file":"streamVideo.dev.js"}