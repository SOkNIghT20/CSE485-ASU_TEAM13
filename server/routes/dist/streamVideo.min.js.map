{"version":3,"sources":["streamVideo.js"],"names":["fs","require","express","Router","path","router","req","res","next","passport","file","console","log","file_name","ext_name","extname","file_type","stat","err","send","code","status","concat","fileSize","size","range","parts","replace","split","start","parseInt","chunksize","end","head","Content-Range","Accept-Ranges","Content-Type","Content-Length","writeHead","createReadStream","pipe","module","exports"],"mappings":"AAAA,aAMA,IAAIA,GAAKC,QAAQ,MACbC,QAAUD,QAAQ,WAAlBC,OAAOA,QAAUC,SAEjBC,KAAOH,QAAQ,QADfI,SAASH,QAAQC,YACrBE,OAAID,IAAOH,UAAX,SAAAK,EAAAC,EAAAC,GACA,IAAMC,EAAWR,EAAAA,MAAQS,KAKxBC,QAAQC,IAAI,4BAA6BC,GADzC,IAAAC,EAAaV,KAAMW,QAAOL,GAC1BC,EAAY,GAQZ,OAAOG,GAHP,IAAIA,OACAE,EAAJ,YAKO,MAHP,IAAA,OACGA,EAAA,WACIA,MACA,IAAA,OAKAA,EAAY,YAInBL,QAAQC,IAAI,WAHLZ,GAAAiB,KAAAJ,EAAA,SAAAK,EAAAD,GATP,GAWAC,EACAP,OAKEA,QAAQC,IAAI,mBAAoBM,GALtB,WAAZP,EAAQC,KAGAC,EAAAA,OAAW,KAAAM,KAAXN,wDAAAA,OAA0BA,EAA1BA,OACE,WAAAK,EAAAE,KAQAb,EAAIc,OAAO,KAAKF,KAAhB,kEAAAG,OAAuFT,EAAvF,OAHPN,EAAOA,OAAIc,KAAOF,KAAlB,mFAAAG,OAAOT,EAAP,OAIAF,QAHMC,IAGA,SAAAC,GACN,IAAAU,EAAAN,EAAAO,KACAC,EAAOlB,EAAIc,QAAOI,MAClB,GAAAA,EAAA,CACD,IAAAC,EAAAD,EAAAE,QAAA,SAAA,IAAAC,MAAA,KAOMC,EAAQC,SAASJ,EAAM,GAAI,IALlCf,EAAAe,EAAY,GACZI,SAAMP,EAAWN,GAAKO,IACtBD,EAAcjB,EAOPyB,EAAaC,EAAMH,EAAS,EANnClB,QAAIc,IAAO,UAAAI,EAAA,MAAAG,EAAA,MAAAD,GACV,IAAArB,EAAWV,GAAGyB,iBAAcZ,EAAce,CAAAA,MAA1CC,EAAAG,IAAAA,IACAC,EAAW,CACXC,gBAAiB,SACdJ,EAASJ,IAAUM,EACnBT,IAAAA,EACHY,gBAAe,QACfxB,iBAAYoB,EAMXK,eAAgBpB,GAL6Ba,EAAAA,UAAOA,IAATI,GAAgBD,EAAAA,KAAKA,OAAjE,CACA,IAAAC,EAAU,CACTI,iBAAAd,EACAa,eAAApB,GAEAT,EAAA+B,UAAA,IAAAL,GAJYjC,GAAAuC,iBAAb1B,GAAA2B,KAAAjC,QASAkC,OAAAC,QAAUrC","file":"streamVideo.min.js","sourcesContent":["\"use strict\";\r\n\r\n//import {videoSource} from \"../../src/app/services/search.component\";\r\n/*\r\nREFERENCE MATERIAL https://medium.com/@daspinola/video-stream-with-node-js-and-html5-320b3191a6b6\r\n */\r\nvar fs = require('fs');\r\nvar express = require('express');\r\nvar router = express.Router();\r\nvar path = require('path');\r\nconst passport = require('passport');\r\n\r\nrouter.get('/stream'/*, passport.authenticate('jwt', { session: false })*/, function (req, res, next) {\r\n\t//var fileName = path.basename(req.query.file);\r\n\tvar file_name = req.query.file;\r\n\tconsole.log(\"streamVideo.js file_name:\", file_name);\r\n\t\t\r\n\t//once we know where files will be located we can switch it out from the /assets folder\r\n\t//const path = file_name; //'assets/sample.mp4';\r\n\t\r\n\tvar ext_name = path.extname(file_name);\r\n\tvar file_type = '';\r\n\t\r\n\tswitch(ext_name) {\r\n    case '.mp4':\r\n        file_type = 'video/mp4';\r\n        break;\r\n    case '.vtt':\r\n        file_type = 'text/vtt';\r\n        break;\r\n    case '.wav':\r\n        file_type = 'audio/wav';\r\n        break;\r\n\t}\r\n\t//console.log(\"streamVideo.js ext:\", ext_name);\r\n\tconsole.log(\"looking\");\r\n\r\n\t// Asynchronously check if the file exists and get its stats\r\n\tfs.stat(file_name, (err, stat) => {\r\n\t\tif (err) {\r\n\t\t\tconsole.log(\"error in lebron:\", err);\r\n\t\t\t// Provide more specific error messages based on the error code\r\n\t\t\tif (err.code === 'ENOENT') {\r\n\t\t\t\t// File not found\r\n\t\t\t\treturn res.status(404).send(`Sorry: Video no longer archived - file not found at \"${file_name}\".`);\r\n\t\t\t} else if (err.code === 'EACCES') {\r\n\t\t\t\t// Permission denied\r\n\t\t\t\treturn res.status(403).send(`Sorry: Video no longer archived - permission denied to access \"${file_name}\".`);\r\n\t\t\t} else {\r\n\t\t\t\t// Other errors\r\n\t\t\t\treturn res.status(500).send(`Sorry: Video no longer archived - an unexpected error occurred while accessing \"${file_name}\".`);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconsole.log(\"found \" + file_name);\r\n\t\tconst fileSize = stat.size;\r\n\t\tconst range = req.headers.range;\r\n\t\tif (range) {\r\n\t\t\tconst parts = range.replace(/bytes=/, \"\").split(\"-\");\r\n\t\t\tconst start = parseInt(parts[0], 10);\r\n\t\t\tconst end = parts[1]\r\n\t\t\t\t? parseInt(parts[1], 10)\r\n\t\t\t\t: fileSize - 1;\r\n\t\t\tconst chunksize = (end - start) + 1;\r\n\t\t\tconsole.log('RANGE: ' + start + ' - ' + end + ' = ' + chunksize);\t//DEBUG\r\n\t\t\tconst file = fs.createReadStream(file_name, { start: start, end: end });\r\n\t\t\tconst head = {\r\n\t\t\t\t'Content-Range': 'bytes ' + start + '-' + end + '/' + fileSize,\r\n\t\t\t\t'Accept-Ranges': 'bytes',\r\n\t\t\t\t'Content-Length': chunksize,\r\n\t\t\t\t'Content-Type': file_type\r\n\t\t\t};\r\n\t\t\tres.writeHead(206, head);\r\n\t\t\tfile.pipe(res);\r\n\t\t} else {\r\n\t\t\tconst head = {\r\n\t\t\t\t'Content-Length': fileSize,\r\n\t\t\t\t'Content-Type': file_type\r\n\t\t\t};\r\n\t\t\tres.writeHead(200, head);\r\n\t\t\tfs.createReadStream(file_name).pipe(res);\r\n\t\t}\r\n\t});\r\n});\r\nmodule.exports = router;\r\n"]}